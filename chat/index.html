<html lang="en"><br><head><br>    <meta charset="utf-8"><br>    <meta http-equiv="x-ua-compatible" content="ie=edge"><br>    <title>私密聊天室</title><br>    <meta name="description" content="私密聊天室"><br>    <meta name="viewport" content="width=device-width, initial-scale=1"><br>    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css"><br>    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap-grid.min.css"><br>    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous"><br>    <link rel="stylesheet" href="css/shards.min.css"><br>    <link rel="stylesheet" href="css/shards-demo.css?v=1.1.0"><br>    <link rel="stylesheet" href="css/index.css"><br>    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><br></head><br><br><script type="text/javascript"><br>    window.onload = function (ev) {<br>        var btnSend = document.getElementById(“send”);<br>        var contentArea = document.getElementById(“content”);<br>        var msgTextArea = document.getElementById(“msgTextArea”);<br><br>        var inputIp = document.getElementById(“input_ip”);<br>        var inputName = document.getElementById(“input_name”);<br><br>        var fromUserName = “小王”;<br>        var wsAddress = “112.74.76.245:9090”;<br>        var conn;<br><br>        var roomId;<br><br>        // ======================= functions =====================<br>        function GetCookie(name) {<br>            var cookieValue = null;<br>            if (document.cookie &amp;&amp; document.cookie !== ‘’) {<br>                var cookies = document.cookie.split(‘;’);<br>                for (var i = 0; i &lt; cookies.length; i++) {<br>                    var cookie = jQuery.trim(cookies[i]);<br>                    // Does this cookie string begin with the name we want?<br>                    if (cookie.substring(0, name.length + 1) == (name + ‘=’)) {<br>                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));<br>                        break;<br>                    }<br>                }<br>            }<br>            return cookieValue;<br>        }<br><br>        function SetCookie(name, value, days) {<br>            var expires = “”;<br>            if (days) {<br>                var date = new Date();<br>                date.setTime(date.getTime() + (days <em> 24 </em> 60 <em> 60 </em> 1000));<br>                expires = “; expires=” + date.toUTCString();<br>            }<br>            document.cookie = name + “=” + value + expires + “; path=/“;<br>        }<br><br>        function appendMessage(content) {<br>            contentArea.innerHTML += content;<br>        }<br><br>        function sendMessage(msg, typ) {<br>            if (typ) {<br>                msg.type = typ<br>            }<br>            if (roomId) {<br>                msg.room = roomId<br>            }<br>            // TODO: get user name from cookies<br>            msg.from = fromUserName;<br>            console.log(“send:”, JSON.stringify(msg));<br>            conn.send(JSON.stringify(msg));<br>        }<br><br>        function changeFromUserName() {<br>            console.log(“失去了焦点”);<br>            console.log(inputName.value);<br>            fromUserName = inputName.value;<br>            console.log(fromUserName);<br>        }<br><br>        // ======================== get from username from cookies =============<br>        fromUserName = GetCookie(“fromUserName”);<br>        if (fromUserName == null) {<br>            // open a dialog input from user name, and set it to cookies<br>            fromUserName = “小王-默认”;<br>        }<br><br>        // ======================== do websocket setup ===================<br>        conn = new WebSocket(“ws://“ + wsAddress + “/ws”);<br>        conn.onopen = function (ev) {<br>            appendMessage(“<span class=\"badge badge-pill badge-success\">已连接</span><p></p>“);<br>            console.log(ev.toString());<br>            // get room list<br>            sendMessage({<br>                type: ‘ROOMS’,<br>            });<br>        };<br>        conn.onerror = function (ev) {<br>            appendMessage(“<span class=\"badge badge-pill badge-danger\">未连接: “ +  ev.toString() + “</span>\n”);<br>            console.log(ev.toString());<br>        };<br>        conn.onmessage = function (evt) {<br>            var message = JSON.parse(evt.data);<br>            if (message.type === ‘ROOMS’) {<br>                if (message.data.length) {<br>                    rooms = JSON.parse(message.data);<br>                    rooms.forEach(function (room) {<br>                        // appendMessage(“<b>“+ room.name + “</b> :” + JSON.stringify(room));<br>                    });<br>                    sendMessage({<br>                        type: ‘JOIN’,<br>                        room: rooms[0].id,<br>                    });<br>                }<br>                return<br>            }<br><br>            if (message.type === ‘JOIN’) {<br>                if (message.data) {<br>                    roomId = message.data;<br>                    var date = message.timestamp ? new Date(message.timestamp) : new Date();<br>                    appendMessage(“<b>“ + date.toLocaleString() + “</b> : 加入了房间 “ + message.data + “<br>“);<br>                } else {<br>                    appendMessage(“<b>加入失败</b>“ + message.data);<br>                }<br>                return<br>            }<br><br>            if (message.data) {<br><br>                var date = new Date(message.timestamp);<br>                var text = “<b>“ + date.toLocaleString() + “</b>: “ + message.from + “: “ + message.data + “<br>“;<br>                appendMessage(text);<br>            } else {<br>                console.error(JSON.stringify(evt));<br>            }<br><br>        };<br><br><br>        function doSend() {<br>            if (msgTextArea.value !== “”) {<br>                // contentArea.innerHTML += “<b>“ + fromUserName + “</b>: “ + msgTextArea.value + “<br>“;<br>                sendMessage({<br>                    data: msgTextArea.value,<br>                    type: ‘MESSAGE’,<br>                });<br>                msgTextArea.value = “”;<br>            }<br>        }<br><br>        btnSend.addEventListener(“click”, function () {<br>            doSend();<br>        });<br>        msgTextArea.addEventListener(‘keyup’, function (event) {<br>            //check to see if the enter key was pressed<br>            if (event.which === 13) {<br>                //if so, run the addTask function<br>                doSend();<br>            }<br>        });<br>        inputName.addEventListener(‘keyup’, function (event) {<br>            if (event.which === 13) {<br>                console.log(inputName.value);<br>                fromUserName = inputName.value;<br>                console.log(fromUserName);<br>            }<br>        });<br>        inputName.addEventListener(‘blur’, function (event) {<br>            changeFromUserName();<br>        });<br>        inputIp.addEventListener(‘keyup’, function (event) {<br>            if (event.which === 13) {<br>                if (inputIp.value !== “”) {<br>                    conn = new WebSocket(“ws://“ + inputIp.value + “/ws”);<br>                }<br>            }<br>        });<br>        inputIp.addEventListener(‘blur’, function (event) {<br>            if (inputIp.value !== “”) {<br>                conn = new WebSocket(“ws://“ + inputIp.value + “/ws”);<br>            }<br>        });<br><br>    }<br><br></script><br><br><body><br><div class="container area-settings"><br>    <div class="row"><br>        <div class="card col-md-6 col-sm-6 offset-md-3"><br>            <div class="row"><br>                <div class="col-md-4 elm-margin-top"><br>                    <input class="form-control" placeholder="服务器IP: localhost" id="input_ip"><br>                </div><br>                <div class="col-md-4 elm-margin-top elm-margin-bottom"><br>                    <input class="form-control" placeholder="我的名字" id="input_name"><br>                </div><br>            </div><br>        </div><br>    </div><br></div><br><br><div class="container area-chat"><br>    <div class="row"><br>        <div class="card col-md-6 col-sm-6 offset-md-3"><br>            <div class="card-body" id="content"><br>                <h3>聊天</h3><br>            </div><br>        </div><br>    </div><br></div><br><br><div class="container area-edit"><br>    <div class="row"><br>        <div class="col-md-4 col-sm-3 offset-md-3 elm-margin-top"><br>            <textarea type="text" class="form-control" placeholder="说点啥" id="msgTextArea" wrap="soft"></textarea><br>        </div><br>        <div class="col-md-2 col-sm-3 elm-margin-top"><br>            <button class="btn btn-primary btn-pill" id="send"><br>                <i class="fa fa-send mr-2"></i><br>                发送<br>            </button><br>        </div><br>    </div><br></div><br></body><br></html>